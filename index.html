<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study Progress Dashboard</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background-color: #0f172a;
      color: #e2e8f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }
    h1 { color: #38bdf8; margin-bottom: 20px; }
    .dashboard, .input-panel {
      width: 90%; max-width: 700px;
      background: #1e293b; border-radius: 12px;
      padding: 20px 30px; margin-bottom: 30px;
      box-shadow: 0 0 15px rgba(56,189,248,0.2);
    }
    .bar { margin-bottom: 20px; }
    .bar-label { display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: 600; align-items: center; }
    .progress-bar { position: relative; height: 25px; background: #334155; border-radius: 30px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0; background: linear-gradient(90deg, #f87171, #facc15, #4ade80); border-radius: 30px; transition: width 1s ease-in-out; }
    .input-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px; }
    input, select {
      background: #334155; border: none; color: #e2e8f0;
      padding: 6px 10px; border-radius: 6px;
    }
    .subject-name { font-weight: 600; }
    .subject-actions { display: flex; align-items: center; gap: 10px; }
    .task-toggle-btn {
      padding: 4px 10px;
      font-size: 0.85rem;
    }
    .task-toggle-btn.open {
      background: #0ea5e9;
      color: #0f172a;
    }
    button {
      background: #38bdf8; border: none; color: #0f172a;
      padding: 6px 14px; border-radius: 6px; cursor: pointer;
      transition: 0.2s;
    }
    button:focus-visible { outline: 2px solid #38bdf8; outline-offset: 2px; }
    button:hover { background: #0ea5e9; }
    .remove-btn { background: #ef4444; color: white; padding: 4px 10px; }
    .remove-btn:hover { background: #dc2626; }
    .task-dropdown {
      display: none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      background: #111827;
      border: 1px solid #334155;
    }
    .task-dropdown.open { display: block; }
    .task-list { list-style: none; padding: 0; margin: 0 0 12px 0; display: flex; flex-direction: column; gap: 8px; }
    .task-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .task-item label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .task-item.empty { justify-content: flex-start; font-style: italic; opacity: 0.75; }
    .task-item.completed span { text-decoration: line-through; opacity: 0.7; }
    .task-input-row { margin-bottom: 0; }
    .task-input-row input { flex: 1; }
  </style>
</head>
<body>
  <h1>ðŸ“˜ Study Progress Dashboard</h1>

  <div class="input-panel">
    <h2 style="color:#38bdf8;">Add Subject</h2>
    <div class="input-row">
      <input type="text" id="subjectName" placeholder="Subject name" />
      <input type="number" id="maxRange" placeholder="Max topics (e.g. 13)" min="1" />
      <button onclick="addSubject()">Add</button>
    </div>
  </div>

  <div id="total-container" class="dashboard" style="margin-bottom:20px;">
  <h2 style="color:#38bdf8;">ðŸ“Š Total Progress</h2>
  <div class="bar">
    <div class="bar-label">
      <span>Overall Study Progress</span>
      <span id="total-label">0/0 (0%)</span>
    </div>
    <div class="progress-bar">
      <div id="total-progress" class="progress-fill"></div>
    </div>
  </div>
</div>

  
  <div id="dashboard" class="dashboard"></div>

  <script>
    let subjects = JSON.parse(localStorage.getItem("subjects")) || {};
    const savedOpenSubjects = JSON.parse(localStorage.getItem("openSubjects"));
    let openSubjects = new Set(Array.isArray(savedOpenSubjects) ? savedOpenSubjects : []);

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getSafeId(name) {
      return `subject-${encodeURIComponent(name).replace(/%/g, "-")}`;
    }

    function decodeName(encodedName) {
      try {
        return decodeURIComponent(encodedName);
      } catch (error) {
        return encodedName;
      }
    }

    function persistOpenSubjects() {
      localStorage.setItem("openSubjects", JSON.stringify([...openSubjects]));
    }

    function saveData() {
      localStorage.setItem("subjects", JSON.stringify(subjects));
      persistOpenSubjects();
    }

    function renderDashboard() {
      const dash = document.getElementById("dashboard");
      dash.innerHTML = "";

      openSubjects = new Set([...openSubjects].filter(name => subjects[name]));
      persistOpenSubjects();

      if (Object.keys(subjects).length === 0) {
        dash.innerHTML = "<p style='text-align:center;opacity:0.8;'>No subjects yet. Add one above!</p>";
        return;
      }

      function updateTotalProgress() {
        const totalLabel = document.getElementById("total-label");
        const totalFill = document.getElementById("total-progress");

        const totalSubjects = Object.keys(subjects).length;
        if (totalSubjects === 0) {
          totalLabel.textContent = "0/0 (0%)";
          totalFill.style.width = "0%";
          return;
        }

        let totalProgress = 0;
        let totalMax = 0;

        Object.values(subjects).forEach(subject => {
          totalProgress += subject.progress;
          totalMax += subject.max;
        });

        const percentage = totalMax > 0 ? (totalProgress / totalMax) * 100 : 0;
        totalLabel.textContent = `${totalProgress}/${totalMax} (${percentage.toFixed(1)}%)`;
        totalFill.style.width = `${percentage}%`;
      }

      let needsSave = false;

      Object.entries(subjects).forEach(([key, subject]) => {
        if (!subject.tasks) {
          subject.tasks = [];
          needsSave = true;
        }
        const { progress, max, tasks } = subject;
        const percentage = max > 0 ? (progress / max) * 100 : 0;
        const safeId = getSafeId(key);
        const encodedName = encodeURIComponent(key);
        const updateInputId = `update-${safeId}`;
        const taskInputId = `task-input-${safeId}`;
        const isOpen = openSubjects.has(key);
        const toggleLabel = isOpen ? "Hide Tasks" : "Show Tasks";
        const toggleClass = isOpen ? "task-toggle-btn open" : "task-toggle-btn";
        const dropdownId = `tasks-${safeId}`;

        const bar = document.createElement("div");
        bar.className = "bar";
        bar.innerHTML = `
          <div class="bar-label">
            <span class="subject-name">${escapeHtml(key)}</span>
              <div class="subject-actions">
                <button
                  type="button"
                  class="${toggleClass}"
                  onclick="toggleTasks('${encodedName}')"
                  aria-expanded="${isOpen ? "true" : "false"}"
                  aria-controls="${dropdownId}"
                >${toggleLabel}</button>
              <span>${progress}/${max} (${percentage.toFixed(1)}%)</span>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${percentage}%;"></div>
          </div>
          <div class="input-row" style="margin-top:8px;">
            <input type="number" id="${updateInputId}" value="${progress}" min="0" max="${max}" />
            <button onclick="updateProgress('${encodedName}', '${updateInputId}')">Update</button>
            <button class="remove-btn" onclick="removeSubject('${encodedName}')">Remove</button>
          </div>
        `;

        const dropdown = document.createElement("div");
        dropdown.className = "task-dropdown";
        dropdown.id = dropdownId;
        dropdown.dataset.subject = key;
        if (isOpen) dropdown.classList.add("open");

        const tasksHtml = tasks.length
          ? tasks
              .map(
                (task, idx) => `
                  <li class="task-item ${task.done ? "completed" : ""}">
                    <label>
                      <input type="checkbox" ${task.done ? "checked" : ""} onclick="toggleTask('${encodedName}', ${idx})" />
                      <span>${escapeHtml(task.text)}</span>
                    </label>
                    <button class="remove-btn" onclick="removeTask('${encodedName}', ${idx})">Delete</button>
                  </li>
                `
              )
              .join("")
          : '<li class="task-item empty">No tasks yet.</li>';

        dropdown.innerHTML = `
          <ul class="task-list">
            ${tasksHtml}
          </ul>
          <div class="input-row task-input-row">
            <input type="text" id="${taskInputId}" placeholder="New task" />
            <button onclick="addTask('${encodedName}', '${taskInputId}')">Add Task</button>
          </div>
        `;

        bar.appendChild(dropdown);
        dash.appendChild(bar);
      });

      if (needsSave) saveData();

      updateTotalProgress();
    }

    function addSubject() {
      const name = document.getElementById("subjectName").value.trim();
      const max = parseInt(document.getElementById("maxRange").value);
      if (!name || isNaN(max) || max <= 0) return alert("Please enter a valid name and range.");
      if (subjects[name]) return alert("Subject already exists!");
      subjects[name] = { progress: 0, max: max, tasks: [] };
      saveData();
      renderDashboard();
      document.getElementById("subjectName").value = "";
      document.getElementById("maxRange").value = "";
    }

    function updateProgress(encodedName, inputId) {
      const name = decodeName(encodedName);
      const input = document.getElementById(inputId);
      if (!input || !subjects[name]) return;
      const newValue = parseInt(input.value);
      if (isNaN(newValue) || newValue < 0 || newValue > subjects[name].max)
        return alert(`Please enter a number between 0 and ${subjects[name].max}`);
      subjects[name].progress = newValue;
      saveData();
      renderDashboard();
    }

    function removeSubject(encodedName) {
      const name = decodeName(encodedName);
      if (!subjects[name]) return;
      delete subjects[name];
      openSubjects.delete(name);
      saveData();
      renderDashboard();
    }

    function toggleTasks(encodedName) {
      const name = decodeName(encodedName);
      if (openSubjects.has(name)) {
        openSubjects.delete(name);
      } else {
        openSubjects.add(name);
      }
      renderDashboard();
    }

    function addTask(encodedName, inputId) {
      const name = decodeName(encodedName);
      const input = document.getElementById(inputId);
      if (!input || !subjects[name]) return;
      const text = input.value.trim();
      if (!text) return alert("Please enter a task description.");
      if (!Array.isArray(subjects[name].tasks)) subjects[name].tasks = [];
      subjects[name].tasks.push({ text, done: false });
      input.value = "";
      openSubjects.add(name);
      saveData();
      renderDashboard();
    }

    function toggleTask(encodedName, index) {
      const name = decodeName(encodedName);
      if (!subjects[name] || !Array.isArray(subjects[name].tasks)) return;
      const task = subjects[name].tasks[index];
      if (!task) return;
      task.done = !task.done;
      openSubjects.add(name);
      saveData();
      renderDashboard();
    }

    function removeTask(encodedName, index) {
      const name = decodeName(encodedName);
      if (!subjects[name] || !Array.isArray(subjects[name].tasks)) return;
      subjects[name].tasks.splice(index, 1);
      openSubjects.add(name);
      saveData();
      renderDashboard();
    }

    // Initialize on load
    document.addEventListener("DOMContentLoaded", renderDashboard);
  </script>
</body>
</html>
